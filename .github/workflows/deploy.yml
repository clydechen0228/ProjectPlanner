name: Deploy MDM Cutover Planner

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build
        run: |
          npm install
          npm run build

      - name: Create package
        run: |
          tar -czf deploy.tar.gz dist Dockerfile nginx.conf backend

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Transfer files to VM'
        run: |
          gcloud compute scp deploy.tar.gz ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_NAME }}:~/mdm-deploy/ --zone ${{ secrets.GCP_ZONE }}

      - name: 'Deploy on VM'
        run: |
          gcloud compute ssh ${{ secrets.GCP_VM_USER }}@${{ secrets.GCP_VM_NAME }} --zone ${{ secrets.GCP_ZONE }} --command "
            cd ~/mdm-deploy && \
            tar -xzf deploy.tar.gz && \
            # Frontend
            sudo docker build -t mdm-cutover-planner . && \
            sudo docker rm -f mdm-planner || true && \
            sudo docker run -d --name mdm-planner --network esg-ai_default -p 3100:80 --restart always mdm-cutover-planner && \
            # Backend
            cd backend && \
            sudo docker build -t mdm-planner-backend . && \
            sudo docker rm -f mdm-planner-backend || true && \
            sudo docker run -d --name mdm-planner-backend --network esg-ai_default -p 8081:8081 \
              -e DATABASE_URL=postgresql://postgres@esg_ai_postgres:5432/ProjectPlanner \
              --restart always mdm-planner-backend
          "
